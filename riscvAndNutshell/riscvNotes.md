> 学习RISC-V架构时的一些笔记

# 主流的指令集的特性

> 目前x86在个人电脑PC和服务器领域占有垄断地位；ARM在嵌入式领域基本占有垄断地位。指令集的成功跟软件生态有着巨大的关系，x86和ARM的成功不光有设计上的功劳，商业运作的功劳也很大。

![image-20221028200428359](https://s2.loli.net/2022/10/29/4BCdltcHYohDFif.png)

## x86

1. 属于CISC
2. 于1978年Intel 8086首次出现
3. 由于Wintel联盟，x86垄断于个人计算机中、同时垄断了服务器市场；在嵌入式中也有
4. 软件生态好
5. 微码化使得CISC指令可以由硬件解码器翻译成内部的简单指令，具有RISC的特点；代价是必须引入硬件解码器

## ARM: Advanced RISC Machines

1. 属于RISC
2. 诞生于英国，主要业务是设计 ARM 架构的处理器，同时提供与 ARM 处理器相关的配套软件，各种 SoC 系统 IP、物理 IP、 GPU、视频和显示等产品
3. 并不是直接生产处理器芯片，而是作为知识产权（ Intellectual Property， IP）供应商。研发一款高性能的应用处理器需要解决挑战极高的技术难题以及投入数年时间，而当 ARM 以年均一款新品之势席卷市场之时， 使得自研处理器没有能够来得及推出便已过时。众多芯片设计厂商，不得不买ARM的IP。
4. RISC的主流架构，应用于嵌入式领域，嵌入式领域可以分为以下三种：
   1. Mobile移动领域：高性能、低功耗，需要加载Linux系统，需要复杂的生态。目前**ARM的Cortex-A系列已经在该领域取得统治地位**，其他处理器架构很难再进入该领域。
   2. Real Time实时领域：生态依赖不如移动领域严重，但是由于ARM出色的IP商业推广，ARM在此领域依旧占据大部分市场份额
   3. 深嵌入式领域，32位：该领域的特点是处理器性能要求不高，更加看中处理器的**低功耗、低成本和能耗比，芯片的需求数量大**，没有很高的生态依赖。但是由于ARM出色的商业推广，**ARM的Cortex-M系列依然在该领域占据大多数市场份额，此外ARC和Andes也有部分的份额**。

## RISC-V

1. 属于RISC
2. x86和ARM经过多年的发展变得极为复杂和冗繁、昂贵，2010，由伯克利提出RISC-V
3. 开源，众多的公司和高校开始拥抱RISC-V（有望打破x86和ARM的生态封锁），建设其生态成为可能
4. RISC-V具有如下特点：
   1. 简单可靠，力图通过架构的定义**使硬件的实现足够简单**。不必承担“向后兼容”的包袱，规避了计算机体系结构中之前研究发现的问题。
   2. 模块化的指令集：模块化的 RISC-V 架构能够使得用户灵活地选择不同的模块进行组合，以满足不同的应用场景
   3. 指令数量少：基本指令就40多条
6. RISC-V优于其他开源架构的地方
   1. 真正开源的指令集架构，而不仅仅是一个开源的处理器核。
   2. 成立了专门的基金会来管理，[RISC-V Tools](https://github.com/riscv-software-src/riscv-tools)
   3. 开源协议不具有污染性，基于RISC-V的指令集改动，不必非要开源，优于OpenRISC架构。
   4. 模块化指令集具有可配置性，满足各种不同的领域需求，优于SPARC架构。
   4. 指令集结构规整，方便译码、便于提高流水线处理器的并行性能和时序

### RISC-V指令集架构特点：从指令集架构上，规定了硬件实现的难度低

> RISC-V 的特点在于**极简、模块化以及可定制扩展**，通过这些指令集的组合或者扩展，几乎可以构建适用于任何一个领域的微处理器，比如云计算、存储、并行计算、虚拟化/容器、 MCU、应用处理器和 DSP 处理器等

| 特性     | x86, ARM                                   | RISC-V                                                       |
| -------- | ------------------------------------------ | ------------------------------------------------------------ |
| 架构篇幅 | 数千页                                     | 少于 300 页                                                  |
| 模块化   | 不支持                                     | 支持模块化可配置的指令子集                                   |
| 可扩展性 | 不支持                                     | 支持可扩展定制指令                                           |
| 指令数目 | 指令数繁多， 不同的架构分支彼<br/>此不兼容 | 一套指令集支持所有架构。基本指令子集仅 40 余条指令，以此为共有<br/>基础，加上其他常用模块子集指令总指令数也仅几十条 |
| 易实现性 | 硬件实现得复杂度高                         | 硬件设计与编译器实现非常简单<br/>• 仅支持小端格式<br/>• 存储器访问指令一次只访问一个元素<br/>• 去除存储器访问指令的地址自增自减模式<br/>• 规整的指令编码格式<br/>• 简化的分支跳转指令与静态预测机制<br/>• 不使用分支延迟槽（ Delay Slot）<br/>• 不使用指令条件码（ Conditional Code）<br/>• 运算指令的结果不产生异常（ Exception）<br/>• 16 位的压缩指令有其对应的普通 32 位指令<br/>• 不使用零开销硬件循环 |



1. 模块化指令子集：RISC-V的指令集模块采用英文字母来区分：

   - I: 整数指令（加法、减法、移位、按位逻辑操作和比较），是**强制实现**的子集，有32个个通用整数寄存器
   - M: 整数乘法和除法
   - A: 存储器*原子操作Atomic*指令和 Load-Reserved/Store-Conditional 指令
   - F: 单精度（ 32 比特）浮点指令，额外32个浮点寄存器组
   - D: 双精度（ 64 比特）浮点指令，必须支持 F 扩展指令，额外32个浮点寄存器组
   - C: 压缩指令，指令长度为 16 位
   - E: “嵌入式”架构，有16个通用整数寄存器

   常见的组合如下有：<u>RV64G 表示 RV64IMAFD</u>，用于大型的 64 位架构；RV32EC 架构用于追求小面积、低功耗的嵌入式场景

2. 寄存器索引放在固定的位置：指令译码器可以快速地译码出寄存器索引，然后快速地读取通用寄存器组，从而提高*流水线*处理器性能和优化时序。

   ![image-20221029102137019](https://s2.loli.net/2022/10/29/ypjFmEWtXdqhYR4.png)

3. 访存指令简单，对应的硬件设计简单：只有load、store可以用于访存；指令不支持地址自增自检模式；采用松散的存储器模型

4. 高效的跳转指令：

   - 2条无条件跳转指令jal, jalr；6条条件跳转指令
   - 将两个操作数的比较和跳转的操作放到一起，在硬件上设计更加简单
   - 默认使用静态分支预测

5. 简洁的子程序调用：子程序的调用需要“保护现场”和“恢复现场”的操作，需要将寄存器的数据存取到存储器

   - 有的RISC架构采用一次读、写多个寄存器，来减少对应的指令条数、提高性能；缺点是硬件设计变得复杂，增加硬件的开销，也可能损伤时序，使得 CPU 的主频无法提高
   - RISC-V一次只能读取一个寄存器；如果刻意要求读取多个寄存器，可以使用公用的程序库（专门用于保存和恢复现场）

6. 无条件码指令：条件码指令用指令的某几位表示条件位，条件位为真的时候，指令才真正执行

   - 条件码的引入可以减少“分支跳转”的出现；增加了硬件难度、损伤了时序
   - RISC-V采用无条件码：对于低功耗小面积的 CPU 可以选择非常简单的电路进行实现，而高性能超标量处理器由于硬件动态调度能力很强，可以有强大的分支预测电路保证 CPU 能够快速地跳转执行达到高性能

7. 无分支延迟槽：分支延迟槽指每一条分支指令后面紧跟的一条或者若干条指令不受分支跳转的影响

8. 无零开销硬件循环：硬件协助的零开销循环是因为在软件代码中的 for 循环（ for i=0;i<N; i++）极为常见

9. 简洁的指令运算

   - 各个指令子集由子集的运算，I子集的运算只有加法、减法、移位、按位逻辑操作和比较
   - 运算的结果不产生软件异常，而是设置控制和状态状态(CSR)寄存器的状态位。
   - RISC-V 架构定义了一套相对<u>简单基本的中断和异常机制</u>，但是也允许用户对其进行定制和扩展

10. 压缩指令

    - 每一条 16 位长的指令都能找到其一一对应的原始 32 位指令
    - 程序编译成为压缩指令仅在汇编器阶段就可以完成，极大地简化了编译器工具链的负担

11. 特权模式：机器模式（必选）、监督模式、用户模式

12. 矢量指令子集：RISC-V 架构将使用可变长度的矢量，而不是矢量定长的 SIMD 指令集

13. 自定制指令扩展：支持第三方的扩展，RISC-V 预留了大量的指令编码空间用于用户的自定义扩展，同时还定义了 4 条 Custom 指令可供用户直接使用

### RISC-V相关的处理器核

1. [Rocket Core](https://github.com/chipsalliance/rocket-chip)
   - 使用Chisel，相比于Verilog具有很高的配置性
   - 性能：按序发射按序执行的五级流水线、完整的指令 Cache 和数据 Cache、64 个深度（ Entries）的分支目标缓存（ Branch Target Buffer, BTB）、256 个深度（ Entries）的分支历史表（ Branch History Table, BHT）、2 个深度（ Entries）的返回地址堆栈（ Return Address Stack, RAS）、配备内存管理单元（ Memory Management Unit， MMU）以支持操作系统
   - 投片、可以运行Linux系统，优于ARM Cortex-A5
2. [BOOM Core](https://chipyard.readthedocs.io/en/stable/Generators/BOOM.html): Berkeley Out-of-Order Machine
   -  面向更高的性能目标，是一款超标量乱序发射、乱序执行的处理器核、支持多核结构
   - 优于ARM Cortex-A9
   - Freedom SoC: SiFive 公司推出的一款开源 SoC
   - LowRISC SoC: 剑桥大学的开发者基于 Rocket Core 而开发
   - PULPino Core and SoC: 苏黎世瑞士联邦理工学院（ ETH Zurich） 开发的一款开源的单核 MCU SoC平台
   - Andes Core: Andes 于 2017 年初发布最新一代的 AndeStar 处理器架构，开始使用 RISC-V 指令集，成为商用主流 CPU IP 公司中第一家采用 RISC-V 指令集架构的公司

# 附录A：其他的一些ISA介绍

## Power

1. 属于RISC
2. 由IBM提出
3. 在超算和高端服务器领域应用十分成功
4. 目前还是活跃的架构，有对应的Open Power联盟

## ARC

1. 属于RISC
2. 由Synopsis公司提出，32位
3. 覆盖低端到高端的嵌入式领域
4. 极高的能效比、面积效率比
5. 极高的可配置性
6. 目前还很活跃，是除了ARM之外的全球最大的嵌入式IP提供商

## Andes

1. 属于RISC
2. 由台湾Andes推出，32位
3. $AndesStar^TM$架构被纳入了RISC-V指令集架构

## C-Sky

1. 属于RISC
2. 由杭州*中天微*提出，32位
3. 应用于嵌入式领域：低功耗、高性能、高代码密度、易使用

## ~~SPARC: Scalable Processor ARChitecture~~

1. 属于RISC
2. 于1985年由Sun公司设计出，架构对外开放
3. 寄存器组具有上百个通用寄存器，性能高
4. 功耗面积太大，不适用于个人计算机和嵌入式，只适用于服务器市场
5. 2017年，推出历史舞台

## ~~MIPS: Microprocessor without Interlocked Piped Stages Architecture~~

1. 属于RISC
2. 由斯坦福大学提出
3. 曾在嵌入式市场占有大量份额
4. 由于商业运作的原因，即将灭绝

## ~~Alpha~~

1. 属于RISC，64位
2. 由DEC公司提出
3. 最早的多核处理器架构
4. 造价昂贵、部署复杂，即将灭绝



# 附录B：国内的CPU芯片设计企业



## x86系

1. 海光：授权了AMD的x86架构
2. 北大众志：授权了AMD的嵌入式架构
3. 兆芯：授权了台湾威盛VIA的x86架构

## ARM 系

ARM具有两种授权方式：授权<u>ARM处理器IP</u>（类似出售发动机），直接通过IP设计SoC芯片；<u>授权ARM架构</u>（类似出售发动机设计图纸），得到ARM架构授权后基于该架构自研处理器核，再由自研的处理器核设计SoC芯片。授权ARM架构的费用远远高于IP授权。

1. 飞腾：中国国防科技大学高性能处理器研究团队建立的企业；定位于高性能服务器、行业业务主机等；使用自研内核；国产服务器芯片第一次在性能上追平 Intel
2. 海思：在移动端华为的麒麟芯片在性能上与高通、三星这些领先的芯片企业处于一个水平；华为已经购买了 ARM 指令集架构授权，开始研发自有的处理器核，主攻服务器市场
3. 展讯：国内手机芯片的翘楚；第二家拥有自主 ARM CPU 关键技术的手机芯片厂商
4. 华芯通：高通与中国贵州政府合资在华成立的芯片公司；获 ARM v8-A 架构授权

## MIPS系

1. 龙芯：已经商用；性能高、可用于高性能服务器；开始开源、建立自己的软件生态；第四个UEFI官方支持的指令集
2. 君正：主要用于可穿戴式嵌入式设备，该领域主要看中性价比、功耗等特点，不易被ARM所垄断

## Power系

中晟宏芯：IBM和NVIDIA等公司成立OpenPower联盟后，中晟宏芯等中国企业签署了授权协议，获得了power授权

## Alpha 系

申威：多核架构和 SIMD 等特色扩展指令集，主要面向高性能计算、服务器领域；“神威太湖之光”超级计算机系统





国内 CPU 各 ISA 派系众多，但是又不能由国家主导指定一种国家标准 ISA，因为国家标准 ISA 这种被局限在一国范围内的技术在当今全球化的趋势下，必然是格格不入且不可能成功的。 

指令集架构对于CPU设计具有重要的作用，对于CPU而言，绝对的硬件技术水平反而不是最重要的。处理器架构长期由以 Intel（ x86 架构）与 ARM（ ARM 架构）为代表的商业巨头公司所掌控及其软件生态环境衍生出的寡头排他效应，成为了普通公司与个人无法逾越的天堑。

所以，国产的芯片设计公司想要实现商业化，必须拥抱具有垄断地位的x86和ARM，但是完全选择x86和ARM又有如下的缺点：

1. 授权费用高
2. 采用x86授权，会与AMD和Intel会形成竞争关系，当威胁到其的时候，其可以收回授权
3. 在架构上始终受制于人，非自主可控

因此RISC-V可以显示出其的如下优点：

1. 相比与ARM与x86，它开源，不会有授权费、也不会受制于人
2. 相比于其他小众的ISA，它由非盈利的组织作为主导者和核心规则的制定者，生态系统中大量的上下游软硬件企业应遵循该组织统一制定的标准规范，对接众多客户需求而实现经济利益的获取；国内国外的芯片公司能够在此开放共赢的生态下进行公平的竞争



# 声明

参考的资料如下：

1. 手把手教你设计CPU——RISC-V处理器 by 胡振波
2. [《RISC-V 登场， Intel 和 ARM 会怕吗》](https://zhuanlan.zhihu.com/p/20813811)
3. [三星开发 RISC-V 架构自主 CPU 内核](https://www.risc-v1.com/thread-2256-1-1.html)
3. [UC Berkeley Chipyard](https://chipyard.readthedocs.io/en/stable/Chipyard-Basics/index.html)